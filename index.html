<script>
/* ===============================
   SAFE INITIAL SETUP
================================ */

document.addEventListener("DOMContentLoaded", () => {

/* ---------- ELEMENTS ---------- */
const editor = document.getElementById("editor");
const gutter = document.getElementById("gutter");
const frame = document.getElementById("referenceFrame");
const hint = document.getElementById("referenceHint");
const root = document.documentElement.style;
const rhythmLight = document.getElementById("rhythmLight");

/* ---------- STATE ---------- */
let PAD_THRESHOLD = 0.45;
let DENSITY_THRESHOLD = 0.38;
let VARIANCE_THRESHOLD = 2.8;
let MAX_GAP = 4.5;
let cmuDict = {};
let audioCtx = null;

/* ===============================
   SETTINGS + SLIDERS
================================ */

function bindSlider(id, setter) {
  const el = document.getElementById(id);
  el.addEventListener("input", e => setter(+e.target.value));
}

bindSlider("padSlider", v => PAD_THRESHOLD = v);
bindSlider("densitySlider", v => DENSITY_THRESHOLD = v);
bindSlider("varianceSlider", v => VARIANCE_THRESHOLD = v);
bindSlider("gapSlider", v => MAX_GAP = v);

/* ===============================
   LOCAL STORAGE
================================ */

const save = (k, v) => localStorage.setItem(k, v);
const load = k => localStorage.getItem(k);

const fontSize = load("fontSize");
const textColor = load("textColor");

if (fontSize) root.setProperty("--font-size", fontSize);
if (textColor) {
  root.setProperty("--text-color", textColor);
  document.getElementById("textColor").value = textColor;
}

/* ===============================
   EDITOR + GUTTER
================================ */

function countSyllables(word) {
  word = word.toLowerCase().replace(/[^a-z]/g, "");
  if (word.length <= 3) return word ? 1 : 0;
  word = word.replace(/e$/, "");
  const g = word.match(/[aeiouy]+/g);
  return g ? g.length : 1;
}

function updateGutter() {
  gutter.textContent = editor.innerText
    .split("\n")
    .map(line =>
      line.split(/\s+/).filter(Boolean)
        .reduce((sum, w) => sum + countSyllables(w), 0)
    ).join("\n");
}

editor.addEventListener("input", updateGutter);
editor.addEventListener("scroll", () => gutter.scrollTop = editor.scrollTop);
updateGutter();

/* Fix Enter */
editor.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    document.execCommand("insertLineBreak");
    updateGutter();
  }
});

/* ===============================
   FONT + COLOR
================================ */

function getFontSize() {
  return parseFloat(getComputedStyle(document.documentElement)
    .getPropertyValue("--font-size"));
}

document.getElementById("fontUp").onclick = () => {
  const s = Math.min(getFontSize() + 1, 72);
  root.setProperty("--font-size", s + "px");
  save("fontSize", s + "px");
  updateGutter();
};

document.getElementById("fontDown").onclick = () => {
  const s = Math.max(getFontSize() - 1, 8);
  root.setProperty("--font-size", s + "px");
  save("fontSize", s + "px");
  updateGutter();
};

document.getElementById("textColor").oninput = e => {
  root.setProperty("--text-color", e.target.value);
  save("textColor", e.target.value);
};

/* ===============================
   FILE OPS
================================ */

document.getElementById("saveBtn").onclick = () => {
  const blob = new Blob([editor.innerText], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "lyrics.txt";
  a.click();
};

document.getElementById("saveAsBtn").onclick = () => {
  const name = prompt("Filename:", "lyrics.txt");
  if (!name) return;
  const blob = new Blob([editor.innerText], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name.endsWith(".txt") ? name : name + ".txt";
  a.click();
};

document.getElementById("openBtn").onclick = () => {
  const i = document.createElement("input");
  i.type = "file";
  i.accept = ".txt";
  i.onchange = e => e.target.files[0].text().then(t => {
    editor.innerText = t;
    updateGutter();
  });
  i.click();
};

document.getElementById("newBtn").onclick = () => {
  if (confirm("Clear editor?")) {
    editor.innerHTML = "";
    updateGutter();
  }
};

document.getElementById("emailBtn").onclick = () => {
  location.href = `mailto:?body=${encodeURIComponent(editor.innerText)}`;
};

/* ===============================
   REFERENCES
================================ */

function setTab(key) {
  document.querySelectorAll(".tab").forEach(t =>
    t.classList.toggle("active", t.dataset.site === key)
  );

  if (key === "rhyme") frame.src = "https://www.rhymezone.com/";
  if (key === "wiki") frame.src = "https://en.wikipedia.org/wiki/Main_Page";
  if (key === "askai") {
    frame.src = "https://yuntian-deng-chatgpt.hf.space/";
    hint.style.display = "block";
  } else hint.style.display = "none";
}

document.querySelectorAll(".tab").forEach(t =>
  t.onclick = () => setTab(t.dataset.site)
);

editor.addEventListener("dblclick", () => {
  const w = window.getSelection().toString().trim();
  if (!w) return;
  const url = `https://www.rhymezone.com/r/rhyme.cgi?Word=${encodeURIComponent(w)}`;
  setTab("rhyme");
  frame.src = url;
});

/* ===============================
   CMU DICTIONARY
================================ */

fetch("./cmudict.json")
  .then(r => r.json())
  .then(d => cmuDict = d);

function cleanWord(w) {
  return w.toLowerCase().replace(/[^a-z']/g, "").replace(/^'+|'+$/g, "");
}

function getPhonemes(word) {
  const e = cmuDict[cleanWord(word).toUpperCase()];
  if (!e) return null;
  return Array.isArray(e) ? e[0].split(" ") : e.split(" ");
}

function getStress(p) {
  return p.map(x => x.match(/\d/)?.[0]).filter(Boolean).map(Number);
}

function analyze(text) {
  return text.split(/\s+/).flatMap(w => {
    const p = getPhonemes(w);
    return p ? getStress(p) : [];
  });
}

/* ===============================
   RHYTHM SCORING
================================ */

function updateRhythm(color) {
  const map = { red:"#f44", yellow:"#fd4", green:"#3fa", off:"#444" };
  rhythmLight.style.backgroundColor = map[color] || "#444";
  rhythmLight.style.boxShadow = `0 0 8px ${map[color] || "#444"}`;
}

function handleSelection() {
  const sel = window.getSelection();
  if (!sel || sel.isCollapsed) return updateRhythm("off");

  const text = sel.toString().replace(/\n+/g, " ").trim();
  if (!text) return;

  const stresses = analyze(text);
  if (stresses.length < 4) return updateRhythm("off");

  updateRhythm("green");
}

document.addEventListener("mouseup", handleSelection);
document.addEventListener("touchend", handleSelection);

/* ===============================
   METRONOME (SAFE AUDIO)
================================ */

const bpmInput = document.getElementById("bpmInput");
const toggleBtn = document.getElementById("metronomeToggle");
const light = document.getElementById("metronomeLight");
let timer = null, beat = 0;

function tick(bpm) {
  if (!audioCtx) audioCtx = new AudioContext();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.frequency.value = beat === 0 ? 1500 : 1000;
  g.gain.value = 0.2;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime + 0.1);
  light.className = "metronome-light on";
  setTimeout(() => light.className = "metronome-light", 100);
  beat++;
}

toggleBtn.onclick = () => {
  if (timer) {
    clearInterval(timer);
    timer = null;
    toggleBtn.textContent = "Start";
    beat = 0;
  } else {
    const bpm = +bpmInput.value;
    tick(bpm);
    timer = setInterval(() => tick(bpm), 60000 / bpm);
    toggleBtn.textContent = "Stop";
  }
};

});
</script>
